<body onload="init()" >
<h1>text</h1>

<span id="log"></span>
<script>

function init() {
    console.log("page loaded")
}
</script>

<script src="bitgojs_min.js"> </script>

<script>

let prevconsole = console.log
class App {
	getIsTest() { return true; }
	//wallet password: asd/asd-ASD
	getWalletPassphrase() { return "asd/asd-ASD" }
	getWalletId() { return "5c869eecb7b033d603b430afbba85850"}
	getAccessToken() {return "v2xe3de01b2a3394785d315b0723523f77ddab9114480ba96bd50828d5974c86ef3"}
    getOtp() { return "000000" }
    getCoin() { return "teth" }
    getDest() { return "0xd21934eD8eAf27a67f0A70042Af50A1D6d195E81" }
    getAmount() { return "1234567890987" }

    setError(msg) { console.error("error: " + msg); }
    setStatus(msg) { console.log("status: " + msg); }
    setResponse(msg) { console.log("result: " + msg); }
}

async function run() {
    try {
        XMLHttpRequest.prototype.origSend = XMLHttpRequest.prototype.send
        XMLHttpRequest.prototype.send = function(body) {
            if ( body )
                this.setRequestHeader( "x-body", body )
            return this.origSend(body)
        }

        localtest = true //(running from chrome, without webview)
        if ( localtest ) {
            app = new App();
        }
        accessToken = app.getAccessToken();
        console.log( "start" )
        env = app.getIsTest() ? "test": "prod" ;
        console.log("env:",env);
        bitgo = new BitGoJS.BitGo({env, accessToken});

        otp = app.getOtp();
        coin = app.getCoin();
        dest=app.getDest();
        amount = app.getAmount();

        console.log( "otp="+otp+ " amount="+amount);
        console.log( "dest="+dest )
        console.log( "token="+accessToken)
        console.log( "coin="+coin )
        app.setStatus("get-wallet")
        wallet = await bitgo.coin(coin).wallets().get({id:app.getWalletId()})
        app.setStatus("unlocking")
        await bitgo.unlock({otp})
        app.setStatus("sending")
        ret = await wallet.sendMany({recipients: [
          {
            amount: app.getAmount(),
            address: app.getDest()
          }],
            walletPassphrase: app.getWalletPassphrase()} )

        app.setResponse(ret)

    } catch (e) {
        console.log("ex", e)
        app.setError(e)
    }
}

try {

    run();


} catch ( e) {
    console.log( "error "+e );
}
</script>

</body>
