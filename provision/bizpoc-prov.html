<head>
    <style type="text/css">
        
        input[type="submit"] {
            background-color: #0099cc;
        }
    </style>
     <style media="screen">
      .noPrint{ display: block; }
      .yesPrint{ display: block !important; }
    </style>
    <style media="print">
      .noPrint{ display: none; }
      .yesPrint{ display: block !important; }
    </style>
</head>


<body onbeforeunload="return confirmExit()"
      onload="toggleDebug(bitgoTestEnv.checked)"  >

	<!--pubEncrypt - built with ./pubencrypt/build.sh -->
    <script src="pubEncrypt.pack.js"></script>
    <script src="files/axios.min.js"></script>
    <script src="files/scrypt-async.js"></script>
    <script src="files/sjcl.js"></script>
    <script src="files/encScrypt.js"></script>
    <script src="files/bitgojs_min.js"></script>
    <script>

    function confirmExit() {
        return "Changes you made ase not be saved."
    }

        //proxy server (to allow API access from html)
    bitgoTestServer = "https://bizpoc2.ddns.tabookey.com:8090"
    bitgoProdServer = "https://bizpoc.ddns.tabookey.com"

    var username
    //var debugProvisioningUrl = "http://localhost:5000"
    var debugProvisioningUrl = "https://dprov-bizpoc.ddns.tabookey.com"
    var releaseProvisioningUrl = "https://prov-bizpoc.ddns.tabookey.com"


    var debugXpub = "xpub661MyMwAqRbcGC7sBziMrckYR6qpD61WJ3Y4Wa7Hyf7Ca3D448khbZRN5yioHsUevG584L7e2Hr83QMN7wFKzBFtBhRwCeMB98Tb2ck9JkE"
    var releaseXpub = "xpub-release"

    var debugWpwdPublicKey =  "-----BEGIN PUBLIC KEY-----\n" +
        "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAoA69Sp7ohM3P/XDapf37\n" +
        "o/n3B5RDtKhDPvJlXTZ3w/uRWFgmFsd1StuvPW3ab2SLw6D9hb9TsdVpForddD+H\n" +
        "dWA1n9RXY87X7lRWsTcFzKna+QoLUMVGH4q9heq2Dzv4wByM1wiykUyGiG+E86J4\n" +
        "M/N3tQhzHQfGzNcoLL22eGzVDZJjCM3ukBZIqXlaueqDJywGvN3hykbnFYJGwkVp\n" +
        "sHHZ1dsxWiEbPWNDgvkv30pi8mLTLD2+ONjKBpaXZecknlwy/Cqc4TWYKg3qT0PR\n" +
        "zIPLyCcnA9jek1A06Z4HTobmO8ah8UesyIvYJSuDxa8cP/h9TMQUJcaaJ/rPSlV9\n" +
        "eGzp2Y9Am0tGFYg8lGQ0/xiVL2YqFh3C4o5nAAJBI+aiiE2YHNhZFaJYz3NHamy6\n" +
        "upmsGnsb9jteqJ8LrR+MsNVYlyARrwJnyQFQ4w0YcNE2FHe5uMR3jznBtvSuIB8c\n" +
        "ug9ad0Ob5EMedxtl7/g+IeHwncRNMHDgVz4HoOzQx5TK54IKDbtYn/cr0GuRCInS\n" +
        "dKmp1iimA9YAq67lD81G4MtooIU0cb4KnCzMeJ3oDkOExiNhaqKXx3ojQWqPL4nN\n" +
        "heFfVqpqirGUtkEN3sbssQY85a7KndSrsT0y0KERWyb3iBWiQLNgMZGsTniPO6gT\n" +
        "xDwcP38YJyT5CqjSIwKvg58CAwEAAQ==\n" +
        "-----END PUBLIC KEY-----\n"

    var releaseWpwdPublicKey = "-----BEGIN PUBLIC KEY-----\n" +
        "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAzGKV9J8WqsrLfFBxQEaq\n" +
        "Js/EFdh38M5/ybvr/p6mm/XAfxx/t6tSVaOpRR6iRJlcitvmi569wV/+KjFoJscQ\n" +
        "iqiYt8zXgWAwLVCwO3Au5izP/dS3oLhtKg5hsGVFcFKYVDSUnvve672sV4xoC+ji\n" +
        "0ukpSX/fDd2Xie+gMr76//NL9M/Gn5EltPNaUx7o1xIgNcN4TapRbJU1+WD4AAoc\n" +
        "UsxHDPYqzW8ScgaMCsoaIcaFh1lIm8CWA3WqexSmpLU53lmhhBkmXh9HECCAcaAD\n" +
        "WAN0P9jLDNLq6hU7g3KlLxEc0+SlDkaiRPDLAAVeH/YC0DdZV4KJaTIONYYThXra\n" +
        "fk97Hk1MbTL/QleVp3MN1p9SxnEwq9tlcWytduSTPM4WkwOTSKNxEnUWfPeX2x5n\n" +
        "RPcsUxMsgVFMzWjzuSmTnuiZhwYxVSsWiN6eHvBq3q0C2hmRaLZg4pVHM3GpHfQW\n" +
        "mYLA7aaAiFCuq6AwLC9KEOfJtcpF+ykX9QhdhrS4GPt03pT3ANgc0N7S/4lchr0l\n" +
        "HlIdurB4fxm57q+wIa1U/Ijr0mYrPaAnoHC9yVTlTI8EWnv7SEvai5Pc4uWLx03+\n" +
        "HSuJ7SbgSA+yfK6rWxbuaHHvEcnZad8MiwEBMqguInQ503RwbrBGIMvyUJAZzc3k\n" +
        "UIPrasmVn3Ql68jByi6QUIMCAwEAAQ==\n" +
       "-----END PUBLIC KEY-----"


    function selectInputText(element) {
        element.select()
    }
    //from: http://jsfiddle.net/epinapala/WdeTM/4/
    function selectText(element) {
        if ( element.type=='text' ) {
            console.log( "selecting input: "+element )
            return selectInputText(element)
        }

        console.log( "selecting span: "+element )

        var doc = document;

        if (doc.body.createTextRange) { // ms
            var range = doc.body.createTextRange();
            range.moveToElementText(element);
            range.select();
        } else if (window.getSelection) { // moz, opera, webkit
            var selection = window.getSelection();            
            var range = doc.createRange();
            range.selectNodeContents(element);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }

    function selectAndCopy(elementid) {
        element=document.getElementById(elementid)
        selectText(element)
        document.execCommand('copy')
    }

    function genpwd(id) {
        var item = document.getElementById(id);
        if ( item.value ) {
            if ( !confirm( "Already created "+(id=="pwd"?"user":"wallet")+" password. Are you sure you want to recreate?"))
                return
        }
        item.value = id+"-"+randomString(50,36)
        selectAndCopy(id)
    }

    async function verifyUserInfo(accessToken, statusid) {
        var statusObj = document.getElementById(statusid);    
        function status(msg) {
            statusObj.innerHTML = msg
        }
        function error(msg) {
            status(statusObj.innerHTML+"<br><font color=red>"+msg+"</font>")
        }
        status("")

        try {
            res = await verifyAccount(accessToken)

            status("Validated: "+res)
        } catch(e) {
            console.log( e)
            error("Verify failed: "+e)
        }

    }

    function getProxy() {
        proxyHost = debugProvServer.checked ? "bizpoc2.ddns.tabookey.com" : "bizpoc.ddns.tabookey.com"
        port = bitgoTestEnv.checked ? 8090: 443

        return "https://"+proxyHost+":"+port
    }

    function getProvisioningServer(debug) {
        return (debug || debugProvServer.checked) ? debugProvisioningUrl : releaseProvisioningUrl
    }


    async function verifyAccount( accessToken, otp, walletpwd, adminotp1, statusfunc ) {

        function status(msg) {
            if ( statusfunc )
                statusfunc(msg)
        }
        istest = bitgoTestEnv.checked

        env = istest ? "test": "prod" ;
        coin = istest ? "teth" : "eth"

        if ( !XMLHttpRequest.prototype.origSend ) {
            XMLHttpRequest.prototype.origSend = XMLHttpRequest.prototype.send
        }

        XMLHttpRequest.prototype.send = function(body) {
            //we're not a client. we can't authenticate with safetynet. we use admin otp instead.
            this.setRequestHeader( "yubikey", adminotp1 )
            return this.origSend(body)
        }

        bitgo = new BitGoJS.BitGo({customRootURI: getProxy(), accessToken });
        if ( !otp && !walletpwd ) {
            let user = await bitgo.me()
            //TODO: tried to automatically accept incoming share request...
            //  failes on "missing prv", which is not documented param
            // let wallets = bitgo.coin(coin).wallets()
            // let walletShares = await wallets.listShares()
            // let share = walletShares.incoming[0]
            // if ( ! share )
            //     throw new Error( "No pending wallet share for "+user.name.full)

            // await  wallets.updateShare({walletShareId:share.id, state:'accepted'})
            username = user.name.full
            return user.name.full 
        }
        status( ".bitgo")

        wallets = await bitgo.coin(coin).wallets().list()
        status( "..wallets")
        wallet = wallets.wallets[0]

        walletAddr = wallet._wallet.coinSpecific.baseAddress
        await bitgo.unlock({otp})
        status( "...unlock")
        await wallet.getPrv({walletPassphrase:walletpwd})
        status( "....prv")
        return "ok"
    }

    async function genActivationKey(statusid, resultid,adminotp1, adminotp, userotp, accesstoken) {

        var statusObj = document.getElementById(statusid)
        var result = document.getElementById(resultid);    
        function status(msg) {
            statusObj.innerHTML = msg
        }
        function error(msg) {
            status(statusObj.innerHTML+"<br><font color=red>"+msg+"</font>")
        }
        status("")

        // we shared the wallet with the customer, so from his perspective, 
        // the wallet password is the user's password. only the admin has different pwd for wallet and user.  
        var walletpwd = document.getElementById("pwd").value.trim()
        console.log( "walletpwd=",walletpwd)
        verify= true //!debugProvServer.checked
        if (verify) {
            if ( !walletpwd ) return error("no wallet password")
            if ( !adminotp ) return error( "Missing admin otp")
            if ( !userotp ) return error( "Missing customer otp")
            if ( !accesstoken.startsWith("v2x")) error("No access token")
            if ( adminotp.substring(0,12) != adminotp1.substring(0,12) ) return error( "admin otp#1 and #2 should be generated by the same yubikey")
            if ( adminotp == adminotp1 ) return error( "generate admin otp twice (in this order), don't copy.")
        } else {
            //debug-only
            if ( !adminotp) adminotp ="cccccckftlhc-OK"
            if ( !adminotp1) adminotp1 ="cccccckftlhc-OK"
            if ( !userotp ) userotp = "userotp"
        }
        key = randomString(12,10)
        status( "verifying account info..")

        try {
            await verifyAccount( accesstoken, userotp, walletpwd, adminotp1 , status)
        } catch(e) {
            console.log(e)
            return error("Verification failed: "+e)
        }

        keyPadded = key.replace(/(\d\d\d\d)\B/g, "$1-")

        // selectAndCopy(resultid)
        checksum = calculateChecksum(key, userotp.substring(0,12))
        keyPadded = keyPadded+"-"+checksum

        serverUrl = getProvisioningServer() + "/putEncryptedCredentials/" + adminotp+"/"+userotp+"/"+checksum

        provisionInfo={
            prod:!bitgoTestEnv.checked,
            token:accesstoken,
            password:walletpwd 
        }
        console.log( serverUrl, JSON.stringify(provisionInfo,null,2))

        status( "calculating scrypt-access-key..")
        encryptWithScrypt( key, JSON.stringify(provisionInfo), (err,encryptedCreds) => {
            if (err) return error(err)

            status( "uploading..")

            axios.post( serverUrl, { encryptedCredentials: JSON.parse(encryptedCreds) }) 
                .then( res=>status("<p>Uploaded.<p>\n"+
                    ( username ? "Customer: "+username+"<br>\n":"" )+
                    "Customer OTP-ID: "+userotp.substring(0,12)+"<br>\n" +
                    "Activation key: "+keyPadded+"<p>" ) )
                .catch( (err)=>error( JSON.stringify( (err.response && err.response.data) || err ) ) )
        })
    }

    function printPage(title, str) {
        w = window.open()
        w.document.write(
            '<body onAfterPrint="window.close()">' + 
            "<H1>"+title+"</H1>\n" +
            str + "\n</body>" )

        w.window.print()
    }
    
    function downloadPage(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

    async function printWalletPassword() {

        enco = new TextEncoder()
        data = enco.encode(wpwd.value)
        pubkey = bitgoTestEnv.checked ? debugWpwdPublicKey : releaseWpwdPublicKey 
        enc = pubEncrypt(pubkey, wpwd.value)
        downloadPage( "wallet-password.txt", enc )
    }

    function checkProvisioningServer(provcheck) {
        function status(msg) {
            provcheck.innerHTML=msg
        }
        status( "checking "+getProvisioningServer() )
        axios.get( getProvisioningServer()+ "/list/asd", {timeout: 5000} )
            .then(res=>{
                //should not reach here... above URL always has "invalid master otp"
                status("server ok?")
            })
            .catch(err=>{
                if ( JSON.stringify(err.response||"").indexOf("Invalid master")>=0 ) {
                    status ( "<font color=green'>Provisioning server OK</font>")
                    return
                } else {
                    status( "<font color=red>Provision server failed: "+err+"</font>")
                }
            })
    }
</script>

<title>BizPOC New Customer Provisioning Flow</title>
<H1>BizPOC New Customer Provisioning Flow</H1>

<h3>Prerequisites:</h3> 
<ol>
<li> Run this script on a TRUSTED host, and only from a local file (NOT form the network)
<li> Must have AUDITOR present.
<li> Must have Bitgo accounts for all guardians, each with his own Yubikey.
</ol>
<p>

<h3>Flow</h3>

<input type="checkbox" id=debugProvServer >  DEBUG: Use debug provisioning/proxy servers (dprov, bizpoc2).<br>
<input type="checkbox" id=bitgoTestEnv onclick='toggleDebug(this.checked)'>  DEBUG: Use Bitgo TESTNET<br>


<script>
    bitgoTestEnv.checked = window.location.href.indexOf('debug')>0

    function toggleDebug(on) {

        document.getElementById('pwd').readOnly = !on
        document.getElementById('wpwd').readOnly = !on
        document.getElementById('keyid').value = new Date().getTime() % 10000000

        if ( on )  {
            document.getElementById("xpub").value = debugXpub
        }
        else {
            document.getElementById("xpub").value = releaseXpub
        }

        seturl( 'signup', on)
        seturl( 'mainlogin', on )
    }

    function seturl(id, debug) {
        aref = document.getElementById(id)
        text = aref.innerText
        if ( debug ) {
            text = text.replace( "www", "test")
        } else {
            text = text.replace( "test", "www")
        }
        aref.innerHTML = text
        aref.href = text

    }
</script>
<ol>

<li> Before starting: <input type=submit value="Check Provisioning Server" onclick="checkProvisioningServer(provcheck)" /><div id=provcheck ></div>

<li> In <b>incognito</b> window, open <a id="signup" href="https://www.bitgo.com/info/signup", target="_incognito">https://www.bitgo.com/info/signup</a>

<li> <input class=".btn" type=submit value="Generate client password (to clipboard)"  onclick="genpwd('pwd')"> - 
     <font size=1><input size=5 id=pwd readonly> </font> <input type=submit value="Copy" onclick="selectAndCopy('pwd')">
     <ol>
    <li> password used by customer's web user, during provisioning only.
    <li> not saved anywhere, since we're generating "Access key" for the app.
    <li> can't be used later (by admin), since login requires Yubikey.
</ol>

<li> Register customer:

    <ol>
    <li> use email with auto-forward to admin's email<br>
        - e.g: if administrator has an email admin@tabookey.com, use admin<b>+customer_name</b>@tabookey.com; e-mails will be sent to admin@tabookey.com
    <li> (Enter full name of customer)
    <li> paste password from clipboard
    </ol>

<li> Close window.
<li> Open mail, <b>"Bitgo Email Verification"</b>. Right-click on <b>"Click to Verify"</b> and open in <b>incognito window</b> again.
<li> Paste password again to login<br>

<li> Add a Yubikey device to user.

<li> Create Customer's Access-Token:
    <ol>
    <li> in customer's window, top-right menu, User-Settings
    <li> Select, "Developer Options" and then "+ Add Access Token"
    <li> Give it a Label
    <li> scroll to the end of the page (very long..)
    <li> Enter "<b>IP Address Allowed</b>": <input readonly id=serverIP value="35.177.187.77, 3.8.171.48" size=25 > <input type=submit value="Copy" onclick="selectAndCopy('serverIP')">
    <li> Check View, Spend, Full-Administrative-Access and "agree"
    <ol>
        <li> (that is, all checkboxes except "create wallets")
    </ol>
    <li> Click <b>"+Add Token"</b>, enter Yubikey
    <li> copy the on-screen access token
    <li> Paste access-token here (must start with <b>v2x...</b>): <input id=accesstoken placeholder="{paste}"> <input type=submit value="Verify" onclick="verifyUserInfo(accesstoken.value.trim(), 'userinfo')"> <span id=userinfo></span>
    </ol>

<li> Open <a id=mainlogin href="https://www.bitgo.com/login" target="admin">https://www.bitgo.com/login</a> as <b>ADMINISTRATOR</b>
<li> Invite customer's email to organization.
        <ol><li> Top-right menu, select "Manage Organization" and <b>Invite Users</b>, as role "Member"</ol>
<li> On <b>Customer's</b> incognito window: refresh page and select organization from top/right menu.
<li> In <b>Admin</b> window: Create new wallet:

    <ol>
    <li> In <b>Chrome/Settings/Advanced/Downloads</b>: change default location to the customer's flash drive<br>
        (otherwise, you'll need to copy the files manually after download)
    <li> Select "Wallets", click "Create Wallet"
    <li> Select coin: <b>Ethereum</b>, click "Create"
    <li> <b>Quick Setup</b>, click "Next"
    <li> Wallet name: (customer name), click "Next"
    <li> Click: <b>Secondary Password</b>. 
    <li> <input type=submit value="Generate wallet password (to clipboard)"  onclick="genpwd('wpwd')"> - <font size=1><input size=4 id=wpwd readonly> </font><input type=submit value="Copy" onclick="selectAndCopy('wpwd')">
    <li> Paste from clipboard <i>wallet password</i> (twice), click "Next"
    <li> Select "<b>I already have a backup key</b>". use This key: <input id=xpub readonly value=xpub--fill-here><input type=submit value="Copy" onclick="selectAndCopy('xpub')"><br>
         "Next" to create wallet.
    <li> Put the following Key-ID: <input id=keyid readonly value=keyid-fill-here size=10><input type=submit value="Copy" onclick="selectAndCopy('keyid')"><br>
    <li> "Next" to create wallet. 
    <li> Save the generated <b>Bitgo Keycard PDF</b> on the secure flash drive
    <li> Follow BitGo instructions to enter activation code (from PDF) to activate wallet. Check all checkboxes and click activate.
    <li> Save the (encrypted) wallet password on the same secure drive <input type=submit value="Save Wallet Password File" onclick="printWalletPassword()">
    </ol>

<li> In <b>Admin</b> window: Invite user to wallet with role "Spender"
    <ol>
    <li> Click "Add User" button
    <li> Tap "select people from your organization"
    <li> Choose customer's email from dropdown.
    <li> Select role "Spender"   
    <li> Switch to the customer's incognito window, to accept invitation to join wallet.
    </ol>

<li> In <b>Admin</b> window: Invite guardians to wallet with role "Admin"
    <ol>
    <li> Click "Add User" button
    <li> Tap "select people from your organization"
    <li> Choose guardians emails from dropdown.
    <li> Select role "Admin"   
    <li> Requires <i>wallet password</i>. from step 12.
    </ol>
<li> Contact guardians and make sure they accept invitation to join wallet.
        <br>
        You can only proceed <b>after</b> guardians (and customer) accepted the invitations.
        <br>
        <i>Note: Guardian should refresh page, select organisation from top/right menu, on top of the page click "Activity" and approve joining the wallet.</i>

<li> Change wallet <b>Policy</b> 
    <ol>
    <li> Check: Approve All Outgoing Transactions
    <li> Check: Require Multiple (2) Admin Approvals
    <li> Must use 2nd guardian to approve these changes.
    </ol>
    
<li> Upload to server:
    <ol>
        <li> Put in <b>ADMINISTRATOR's</b> Yubikey OTP #1: <input id=adminotp1 onfocus="select()">
        <li> Put in <b>ADMINISTRATOR's</b> Yubikey OTP #2: <input id=adminotp onfocus="select()">
        <li> Put in <i>Customer's</i> Yubikey OTP-ID: <input id=otp onfocus="select()">

    <ol>
          <li> Script below uses above <i>wallet password</i>
          <li>Customer's Yubikey not verified here: can put id (12chars) or entire key
    </ol>

    <li> Click <input type=submit value="Upload User Info"
        onclick="genActivationKey('genstatus', 'activationKey',
                    adminotp1.value.trim(),
                    adminotp.value.trim(),
                    otp.value.trim(),
                    accesstoken.value.trim())"
        >
     <b><div id=genstatus></div></b>
    <li> Save above activation key (until user receives Yubikey) 
    </ol>
<li>Put initial deposit $4.99 in ETH into wallet.
   
<li> Send Yubikey to user.
</ol>
<h3> After Yubikey is received by customer: </h3>

<ol>
<li> Make video call, validate customer
<li> Customer must enable fingerprint on device.
<li> Let customer install App (from Google Play)
<li> Cutomer launches application: 
    <ol>
    <li> App requires user to enter Yubikey
    <li> Guardian gives <b>activation key</b> to customer on the phone
    <li> Customer enters <b>activation key</b>
    <li> Customer click <b>VERIFY</b> (enabled only if activation key is valid for yubikey)
    <ol>
    <li> ~30 seconds waiting:
    <li> Pull encryped data from server, decrypt, configure app.
    </ol>
    <li> App says "<b>Woohoo!</b>"
    </ol>
</ol>
<h3>Perform first transaction with client</h3>

</ol>


</body>
